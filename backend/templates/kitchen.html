<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Rhythm Game üç≥</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
            overflow: hidden;
            height: 100vh;
        }

        /* Game Container */
        #game-container {
            width: 100%;
            height: 100vh;
            position: relative;
            background: linear-gradient(to bottom, #ffeaa7 0%, #fff5e6 100%);
        }

        /* Header */
        #game-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
            padding: 1rem 2rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border-bottom: 4px solid #d63031;
        }

        #game-title {
            font-size: 2.5rem;
            color: white;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.3);
            letter-spacing: 2px;
            font-weight: 700;
        }

        /* Score Display */
        #score-display {
            position: absolute;
            bottom: 120px;
            right: 2rem;
            background: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            border: 3px solid #d63031;
            z-index: 20;
        }

        #score-display h3 {
            color: #d63031;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        #score {
            font-size: 2rem;
            color: #2d3436;
            font-weight: 700;
        }

        #combo {
            font-size: 1rem;
            color: #fdcb6e;
            margin-top: 0.3rem;
            font-weight: 600;
        }

        /* Countdown Overlay */
        #countdown-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-in;
        }

        #countdown-overlay.active {
            display: flex;
        }

        #countdown-number {
            font-size: 15rem;
            color: white;
            font-weight: 700;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.8),
                         0 0 60px rgba(255, 255, 255, 0.5);
            animation: countdownPulse 1s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes countdownPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Note Highway - 3 tracks like sheet music */
        #note-highway {
            position: relative;
            width: 90%;
            margin: 2rem auto;
            padding: 2rem;
        }

        /* Individual Track Row */
        .track {
            position: relative;
            height: 100px;
            margin-bottom: 1.5rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 15px;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden; /* CRITICAL: Clips notes to track boundaries */
        }

        /* Track Label */
        .track-label {
            position: absolute;
            left: -120px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            border: 3px solid;
            z-index: 10;
            min-width: 100px;
            text-align: center;
        }

        .track[data-utensil="pan"] { background: rgba(255, 107, 107, 0.2); }
        .track[data-utensil="pan"] .track-label { 
            color: #ff6b6b; 
            border-color: #ff6b6b; 
        }

        .track[data-utensil="cutting_board"] { background: rgba(106, 176, 76, 0.2); }
        .track[data-utensil="cutting_board"] .track-label { 
            color: #6ab04c; 
            border-color: #6ab04c; 
        }

        .track[data-utensil="mixing_bowl"] { background: rgba(52, 152, 219, 0.2); }
        .track[data-utensil="mixing_bowl"] .track-label { 
            color: #3498db; 
            border-color: #3498db; 
        }

        /* Timing Bar - where notes should be hit */
        .timing-bar {
            position: absolute;
            right: 15%;
            top: 0;
            bottom: 0;
            width: 6px;
            background: linear-gradient(to bottom,
                transparent 0%,
                rgba(214, 48, 49, 0.3) 20%,
                #d63031 50%,
                rgba(214, 48, 49, 0.3) 80%,
                transparent 100%
            );
            z-index: 50; /* Above notes so it's always visible */
            box-shadow: 0 0 15px rgba(214, 48, 49, 0.6);
            border-radius: 3px;
        }

        .timing-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.9); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        }

        /* Notes */
        .note {
            position: absolute;
            left: 0%; /* Start at left edge of track */
            top: 50%;
            transform: translateY(-50%);
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 4px solid;
            z-index: 3;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* TAP Note - Circle/Bubble style */
        .note.tap {
            background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
            border-radius: 50%;
            width: 70px;
            height: 70px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: 700;
        }

        /* HOLD Note - Elongated pill with stripes */
        .note.hold {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-radius: 35px;
            min-width: 150px;
            position: relative;
            overflow: hidden;
        }

        .note.hold::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 10px,
                rgba(255,255,255,0.3) 10px,
                rgba(255,255,255,0.3) 20px
            );
            z-index: 1;
        }

        .note.hold .note-content {
            position: relative;
            z-index: 2;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .note.hold::after {
            content: '‚è±Ô∏è';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            z-index: 2;
        }

        /* Different utensil colors */
        .note[data-utensil="pan"] { border-color: #ff6b6b; color: #ff6b6b; }
        .note[data-utensil="cutting_board"] { border-color: #6ab04c; color: #6ab04c; }
        .note[data-utensil="mixing_bowl"] { border-color: #3498db; color: #3498db; }

        /* Note animations - slides left to right across full track */
        @keyframes slideNote {
            from { 
                left: 0%; 
                opacity: 1;
            }
            to { 
                left: 100%; /* Slides completely across and off the track */
                opacity: 1;
            }
        }

        /* Hit feedback */
        .hit-feedback {
            position: absolute;
            right: 15%;
            top: 50%;
            transform: translate(50%, -50%);
            font-size: 2rem;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            z-index: 100;
            animation: popFeedback 0.6s ease-out;
            pointer-events: none;
        }

        @keyframes popFeedback {
            0% { transform: translate(50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(50%, -50%) scale(1.3); opacity: 1; }
            100% { transform: translate(50%, -50%) scale(1) translateY(-30px); opacity: 0; }
        }

        .hit-feedback.hit { color: #00b894; }
        .hit-feedback.miss { color: #d63031; }
        .hit-feedback.hold-start { color: #fdcb6e; }
        .hit-feedback.hold-complete { color: #6c5ce7; }
        .hit-feedback.hold-break { color: #ff7675; }

        /* Bottom section placeholder */
        #bottom-section {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: calc(100vh - 500px);
            background: linear-gradient(to bottom, transparent 0%, rgba(255,255,255,0.3) 100%);
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
            padding: 2rem;
        }

        #placeholder-text {
            font-size: 1.5rem;
            color: rgba(0,0,0,0.2);
            text-align: center;
            font-weight: 600;
            width: 100%;
        }

        /* Animation Container */
        #animation-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 0;
            width: 90%;
            margin-left: 0;
            flex-wrap: nowrap;
        }

        .animation-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0;
            flex: 1;
            justify-content: center;
        }

        .animation-item-label {
            display: none;
        }

        .animation-image {
            width: 250px;
            height: 250px;
            object-fit: contain;
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            transition: transform 0.3s ease;
        }

        .animation-image:hover {
            transform: scale(1.05);
            box-shadow: none;
        }

        .animation-image.hit {
            animation: hitPulse 0.5s ease-out;
        }

        @keyframes hitPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.15); }
            100% { transform: scale(1); }
        }

        /* Debug info */
        #debug-info {
            position: absolute;
            top: 220px;
            left: 1rem;
            background: rgba(0,0,0,0.7);
            color: #0f0;
            padding: 0.5rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.8rem;
            max-width: 300px;
            z-index: 20;
        }

        /* Instructions Modal */
        #instructions-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-in;
        }

        #instructions-modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            border: 4px solid #d63031;
        }

        .modal-content h2 {
            color: #d63031;
            font-size: 2.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 700;
        }

        .modal-content h3 {
            color: #ff6b6b;
            font-size: 1.5rem;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .modal-content p {
            color: #2d3436;
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .modal-content ul {
            color: #2d3436;
            font-size: 1.1rem;
            line-height: 1.8;
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal-content li {
            margin-bottom: 0.5rem;
        }

        .instrument-icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        #close-modal-btn {
            display: block;
            margin: 2rem auto 0;
            padding: 1rem 2.5rem;
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,184,148,0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        #close-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,184,148,0.6);
        }

        #close-modal-btn:active {
            transform: translateY(0);
        }

        /* Help Button */
        #help-btn {
            position: absolute;
            top: 1.5rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%);
            color: white;
            border: 3px solid white;
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(108,92,231,0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(108,92,231,0.6);
        }

        #help-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>

<body>
<div id="game-container">
    <!-- Instructions Modal -->
    <div id="instructions-modal" class="active">
        <div class="modal-content">
            <h2>üç≥ How to Play üéµ</h2>
            
            <h3>üéÆ Game Objective</h3>
            <p>Use physical kitchen utensils to hit notes as they reach the timing bar! Each track corresponds to a different utensil.</p>
            
            <h3>üîß The Instruments</h3>
            <ul>
                <li><span class="instrument-icon">üç≥</span><strong>Pan:</strong> Toggle heat between high (üî•) and low (üå°Ô∏è)</li>
                <li><span class="instrument-icon">üî™</span><strong>Knife:</strong> Lift the knife up (‚¨ÜÔ∏è) when notes appear</li>
                <li><span class="instrument-icon">ü•£</span><strong>Bowl:</strong> Rotate/mix the bowl (üåÄ) when prompted</li>
            </ul>
            
            <h3>üìä Scoring</h3>
            <ul>
                <li><strong>Tap Notes:</strong> 100 points for hitting at the right time</li>
                <li><strong>Hold Notes:</strong> Hold the action for the duration shown</li>
                <li><strong>Perfect Hit:</strong> Within 50ms of the timing bar</li>
                <li><strong>Combo:</strong> Chain hits together for higher scores!</li>
            </ul>
            
            <h3>üéØ Tips</h3>
            <ul>
                <li>Watch notes slide from left to right across each track</li>
                <li>Perform the action when notes reach the red timing bar</li>
                <li>Hold notes show duration - maintain the action!</li>
                <li>Miss too many and your combo resets to 0</li>
            </ul>
            
            <button id="close-modal-btn">üéÆ Start Playing!</button>
        </div>
    </div>

    <!-- Countdown Overlay -->
    <div id="countdown-overlay">
        <div id="countdown-number">3</div>
    </div>

    <!-- Help Button -->
    <button id="help-btn" title="Show Instructions">?</button>

    <!-- Header -->
    <div id="game-header">
        <h1 id="game-title">üç≥ Kitchen Rhythm üéµ</h1>
    </div>

    <!-- Score Display -->
    <div id="score-display">
        <h3>Score</h3>
        <div id="score">0</div>
        <div id="combo">Combo: 0x</div>
    </div>

     <button id="restart-btn" style="margin-top: 1rem; padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; background: #e74c3c; color: white; border: none; border-radius: 8px; font-weight: 600;">üîÑ Restart Song</button>

    <!-- Debug Info 
    <div id="debug-info">
        <div>Waiting for notes...</div>
    </div>
    -->

    <!-- Note Highway - 3 separate tracks -->
    <div id="note-highway">
        <!-- Pan Track -->
        <div class="track" data-utensil="pan">
            <div class="track-label">üç≥ PAN</div>
            <div class="timing-bar"></div>
        </div>

        <!-- Cutting Board Track -->
        <div class="track" data-utensil="cutting_board">
            <div class="track-label">üî™ KNIFE</div>
            <div class="timing-bar"></div>
        </div>

        <!-- Mixing Bowl Track -->
        <div class="track" data-utensil="mixing_bowl">
            <div class="track-label">ü•£ BOWL</div>
            <div class="timing-bar"></div>
        </div>
    </div>

    <!-- Bottom Section (placeholder) -->
    <div id="bottom-section">
        <div id="placeholder-text">
            üéÆ Get ready to cook! üéÆ
        </div>
        <div id="animation-container">
            <div class="animation-item">
                <div class="animation-item-label">üç≥ PAN</div>
                <img id="pan-animation" class="animation-image" src="/static/animation/pan_idle.png" alt="Pan animation">
            </div>
            <div class="animation-item">
                <div class="animation-item-label">üî™ KNIFE</div>
                <img id="knife-animation" class="animation-image" src="/static/animation/knife_idle.png" alt="Knife animation">
            </div>
            <div class="animation-item">
                <div class="animation-item-label">ü•£ BOWL</div>
                <img id="bowl-animation" class="animation-image" src="/static/animation/bowl_idle.png" alt="Bowl animation">
            </div>
        </div>
    </div>
</div>

<script>
    // ============================================================================
    // GAME STATE
    // ============================================================================
    const socket = io();
    
    let score = 0;
    let combo = 0;
    let activeNotes = new Map(); // Map of note ID -> note element

    const LEAD_TIME = 3; // seconds (must match backend)

    // ============================================================================
    // ANIMATION MAPPING (frame-based)
    // ============================================================================
    const animationMap = {
        'pan': {
            idle: '/static/animation/pan_idle.png',
            frames: ['/static/animation/pan_hit_1.png', '/static/animation/pan_hit_2.png'],
            fps: 5,
            element: null,
            timerId: null,
            frameIndex: 0
        },
        'cutting_board': {
            idle: '/static/animation/knife_idle.png',
            frames: ['/static/animation/knife_hit_1.png', '/static/animation/knife_hit_2.png'],
            fps: 8,
            element: null,
            timerId: null,
            frameIndex: 0
        },
        'mixing_bowl': {
            idle: '/static/animation/bowl_idle.png',
            frames: ['/static/animation/bowl_stir_1.png', '/static/animation/bowl_stir_2.png'],
            fps: 8,
            element: null,
            timerId: null,
            frameIndex: 0
        }
    };

    // Initialize animation elements
    function initializeAnimations() {
        animationMap['pan'].element = document.getElementById('pan-animation');
        animationMap['cutting_board'].element = document.getElementById('knife-animation');
        animationMap['mixing_bowl'].element = document.getElementById('bowl-animation');
        console.log('[ANIMATION] Initialized animation elements');
    }

    // Start frame-based animation that loops for a set duration then reverts to idle
    function playHitAnimationFrames(utensil, durationMs = 1000) {
        const animData = animationMap[utensil];
        if (!animData || !animData.element) return;

        // Clear any existing timer
        if (animData.timerId) {
            clearInterval(animData.timerId);
            animData.timerId = null;
        }

        animData.frameIndex = 0;
        const interval = 1000 / (animData.fps || 10);

        // Start looping frames
        animData.timerId = setInterval(() => {
            const frame = animData.frames[animData.frameIndex % animData.frames.length];
            animData.element.src = frame;
            animData.frameIndex += 1;
        }, interval);

        // Stop after duration and revert to idle
        setTimeout(() => {
            if (animData.timerId) {
                clearInterval(animData.timerId);
                animData.timerId = null;
            }
            animData.frameIndex = 0;
            animData.element.src = animData.idle;
        }, durationMs);
    }

    // Function to show hit animation (legacy name - now calls frame-based version)
    function showHitAnimation(utensil) {
        playHitAnimationFrames(utensil, 1000);
    }

    // ============================================================================
    // INSTRUCTIONS MODAL
    // ============================================================================
    const instructionsModal = document.getElementById('instructions-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const helpBtn = document.getElementById('help-btn');

    // Close modal when button is clicked
    closeModalBtn.addEventListener('click', () => {
        instructionsModal.classList.remove('active');
        console.log('[INSTRUCTIONS] Modal closed');
    });

    // Open modal when help button is clicked
    helpBtn.addEventListener('click', () => {
        instructionsModal.classList.add('active');
        console.log('[INSTRUCTIONS] Modal opened via help button');
    });

    // Close modal when clicking outside the content
    instructionsModal.addEventListener('click', (e) => {
        if (e.target === instructionsModal) {
            instructionsModal.classList.remove('active');
            console.log('[INSTRUCTIONS] Modal closed by clicking outside');
        }
    });

    console.log('[INSTRUCTIONS] Modal will show on first load');

    // ============================================================================
    // SOCKET EVENT HANDLERS
    // ============================================================================

    socket.on('connect', () => {
        console.log('Connected to server');
        console.log('[DEBUG] Socket ID:', socket.id);
        console.log('[DEBUG] Socket connected:', socket.connected);
        console.log('[DEBUG] Socket URL:', socket.io.uri);
        // Test emit to verify connection
        socket.emit('test_connection', {message: 'Hello from frontend'});
        // updateDebug('Connected! Waiting for chart...');
    });

    socket.on('test_response', (data) => {
        console.log('[TEST RESPONSE] Backend responded:', data);
    });

    socket.on('connect_error', (error) => {
        console.error('[ERROR] Connection error:', error);
    });

    socket.on('disconnect', (reason) => {
        console.log('[DISCONNECT] Reason:', reason);
    });

    socket.on('chart_event', (event) => {
        // Visual event: Show note on screen
        // event = {instrument, target, event_time, server_time, duration, is_hold}
        console.log('[CHART EVENT]', event);
        createNote(event);
    });

    socket.on('target_active', (event) => {
        // Backend has activated this target for hit detection
        // event = {utensil, instrument, target, event_time}
        console.log('[TARGET ACTIVE]', event);
        // updateDebug(`Active: ${event.utensil} ‚Üí ${event.target}`);
    });

    socket.on('note_result', (result) => {
        // Hit/miss result from backend
        // result = {utensil, instrument, result, note_type, time, scheduled, accuracy_ms, ...}
        console.log('[NOTE RESULT]', result);
        handleNoteResult(result);
    });

    socket.on('mqtt_message', (message) => {
        // Raw MQTT data - trigger animation on ANY player action
        return;

        if (message.is_json) {
            const payload = JSON.parse(message.payload);
            
            // Detect utensil type
            const utensil = payload.utensil;
            
            if (!utensil) return;
            
            // ============================================
            // üç≥ PAN 
            // ============================================
            if (utensil === 'pan') {
                const data = payload.data || {};
                
                if (data.button === true || data.distance === true) {
                    console.log('[ANIMATION] Pan action detected!');
                    showHitAnimation('pan');
                }
            }
            
            // ============================================
            // üî™ KNIFE 
            // ============================================
            else if (utensil === 'cutting_board') {
                const data = payload.data || {};
                
                const hasTouch = data['0'] === 1 || data['1'] === 1 || data['2'] === 1;
                
                if (hasTouch) {
                    console.log('[ANIMATION] Knife action detected!');
                    showHitAnimation('cutting_board');
                }
            }
            
            // ============================================
            // ü•£ BOWL 
            // ============================================
            else if (utensil === 'mixing_bowl') {
                const data = payload.data || {};
                const isStirring = (data.speed > 0);
                
                console.log('[BOWL] Speed:', data.speed, 'Radius:', data.radius, 'Stirring:', isStirring);
                
                if (isStirring && canTriggerAnimation('mixing_bowl')) {
                    console.log('[BOWL] ‚úÖ Animation triggered!');
                    playHitAnimationFrames('mixing_bowl', 800);
                }
            }
        }
    });

    socket.on('chart_restarted', () => {
        console.log('[RESTART] Chart has been restarted');
        // Reset frontend state
        score = 0;
        combo = 0;
        updateScore();
        // Clear all active notes
        activeNotes.forEach(note => note.remove());
        activeNotes.clear();
    });

    socket.on('countdown', (data) => {
        console.log('[COUNTDOWN]', data.count);
        const overlay = document.getElementById('countdown-overlay');
        const number = document.getElementById('countdown-number');
        
        // Show the overlay
        overlay.classList.add('active');
        
        // Update the countdown number
        number.textContent = data.count;
        
        // Remove animation and re-trigger it
        number.style.animation = 'none';
        setTimeout(() => {
            number.style.animation = 'countdownPulse 1s ease-out';
        }, 10);
        
        // Hide overlay after "GO"
        if (data.count === 'GO') {
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 1000);
        }
    });

    // ============================================================================
    // NOTE CREATION & ANIMATION
    // ============================================================================

    function createNote(event) {
        const utensil = event.utensil;
        const track = document.querySelector(`.track[data-utensil="${utensil}"]`);
        
        if (!track) {
            console.warn('Unknown utensil:', utensil);
            return;
        }

        // Calculate timing
        const now = Date.now() / 1000;
        const timeUntilHit = (event.event_time - now) * (1 /0.85);
        
        // IMPORTANT: The note should travel from left edge to timing bar (85% position)
        // If timeUntilHit is very small, the note appears too late
        // We want notes to be visible for the full LEAD_TIME duration
        
        // Calculate how long the animation should take
        // The note needs to reach the timing bar at event_time
        const animationDuration = Math.max(timeUntilHit, 0.2); // At least 0.5s visible
        
        console.log(`[NOTE CREATE] ${utensil} - Time until hit: ${timeUntilHit.toFixed(2)}s, Animation: ${animationDuration.toFixed(2)}s`);
        // (`Note spawned: ${utensil} in ${timeUntilHit.toFixed(1)}s`);

        // Create note element
        const note = document.createElement('div');
        note.className = `note ${event.is_hold ? 'hold' : 'tap'}`;
        note.dataset.utensil = utensil;
        note.dataset.eventTime = event.event_time;
        note.dataset.noteId = `${utensil}-${event.event_time}`;
        
        // FORCE VISIBILITY FOR DEBUGGING
        note.style.opacity = '1';
        note.style.zIndex = '100';
        
        // Set note content
        const noteText = formatTarget(utensil, event.target);
        
        if (event.is_hold) {
            const content = document.createElement('div');
            content.className = 'note-content';
            content.innerHTML = `<span>${noteText}</span><span style="font-size:10rem;">${event.duration.toFixed(1)}s</span>`;
            note.appendChild(content);
            
            // Make hold note width proportional to duration
            const baseWidth = 150;
            const widthPerSecond = 30;
            note.style.minWidth = `${baseWidth + (event.duration * widthPerSecond)}px`;
        } else {
            note.textContent = noteText;
        }

        // Add to track
        track.appendChild(note);
        
        console.log(`[NOTE ADDED] Note element added to DOM:`, note);
        console.log(`[NOTE POSITION] Initial left: ${note.style.left}, computed: ${getComputedStyle(note).left}`);

        // Start animation (left to right)
        // The animation will take the note from left edge (0%) to timing bar (85%)
        note.style.animation = `slideNote ${animationDuration}s linear forwards`;
        
        console.log(`[NOTE ANIMATION] Animation started: slideNote ${animationDuration}s`);

        // Store reference
        activeNotes.set(note.dataset.noteId, note);
        
        console.log(`[ACTIVE NOTES] Total active: ${activeNotes.size}`);

        // Auto-remove after animation + grace period
        setTimeout(() => {
            if (activeNotes.has(note.dataset.noteId)) {
                console.log(`[NOTE REMOVE] Removing note: ${note.dataset.noteId}`);
                note.remove();
                activeNotes.delete(note.dataset.noteId);
            }
        }, (animationDuration + 1) * 1000);
    }

    function formatTarget(utensil, target) {
        if (utensil === 'pan') {
            if (target === 'high+on') return 'üî•üç≥';
            if (target === 'high+off') return 'üî•üö´';
            if (target === 'low+on') return 'üå°Ô∏èüç≥';
            if (target === 'low+off') return 'üå°Ô∏èüö´';
            // Legacy support
            if (target === 'high') return 'üî•';
            if (target === 'medium') return 'üî•';
            if (target === 'low') return 'üå°Ô∏è';
            return target;
        } else if (utensil === 'cutting_board') {
            return '‚¨ÜÔ∏è';
        } else if (utensil === 'mixing_bowl') {
            return 'üåÄ';
        }
        return target;
    }

    // ============================================================================
    // HIT RESULT HANDLING
    // ============================================================================

    function handleNoteResult(result) {
        const { utensil, result: resultType, note_type, accuracy_ms, completion_percent } = result;
        
        // Update score and combo
        if (resultType === 'hit' || resultType === 'hold_start') {
            score += 100;
            combo++;
            showFeedback(utensil, resultType, accuracy_ms);
            showHitAnimation(utensil);
        } else if (resultType === 'hold_complete') {
            score += 300; // Bonus for completing hold
            combo++;
            showFeedback(utensil, resultType);
            showHitAnimation(utensil);
        } else if (resultType === 'hold_break') {
            score += Math.floor(completion_percent); // Partial credit
            combo = 0;
            showFeedback(utensil, resultType, null, completion_percent);
        } else if (resultType === 'miss') {
            combo = 0;
            showFeedback(utensil, resultType);
        }

        updateScore();
    }

    function showFeedback(utensil, resultType, accuracy_ms = null, completion = null) {
        const track = document.querySelector(`.track[data-utensil="${utensil}"]`);
        
        const feedback = document.createElement('div');
        feedback.className = `hit-feedback ${resultType}`;
        
        // Set feedback text
        if (resultType === 'hit') {
            if (accuracy_ms !== null && Math.abs(accuracy_ms) < 50) {
                feedback.textContent = '‚ú® PERFECT! ‚ú®';
            } else {
                feedback.textContent = '‚úì GOOD!';
            }
        } else if (resultType === 'hold_start') {
            feedback.textContent = 'üéØ HOLD!';
        } else if (resultType === 'hold_complete') {
            feedback.textContent = '‚≠ê EXCELLENT! ‚≠ê';
        } else if (resultType === 'hold_break') {
            feedback.textContent = `üíî ${completion}%`;
        } else if (resultType === 'miss') {
            feedback.textContent = '‚úó MISS';
        }
        
        track.appendChild(feedback);
        
        // Remove after animation
        setTimeout(() => feedback.remove(), 600);
    }

    function updateScore() {
        document.getElementById('score').textContent = score;
        document.getElementById('combo').textContent = `Combo: ${combo}x`;
    }

    // function updateDebug(message) {
    //     const debugDiv = document.getElementById('debug-info');
    //     const timestamp = new Date().toLocaleTimeString();
    //     debugDiv.innerHTML = `<div>[${timestamp}] ${message}</div>` + debugDiv.innerHTML;
        
    //     // Keep only last 5 messages
    //     const messages = debugDiv.querySelectorAll('div');
    //     if (messages.length > 5) {
    //         messages[messages.length - 1].remove();
    //     }
    // }

    // ============================================================================
    // RESTART FUNCTIONALITY
    // ============================================================================

    const restartBtn = document.getElementById('restart-btn');
    if (restartBtn) {
        restartBtn.addEventListener('click', () => {
            console.log('[RESTART] Requesting chart restart...');
            socket.emit('restart_chart');
        });
        console.log('[DEBUG] Restart button listener attached');
    } else {
        console.error('[ERROR] Restart button not found!');
    }


    // ============================================================================
    // INITIALIZATION
    // ============================================================================

    initializeAnimations();
    console.log('Kitchen Rhythm Game loaded! üéÆ');
</script>
</body>
</html>